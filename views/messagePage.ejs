<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS</title>
    <link rel="shortcut icon" href="./assets/logo.svg" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="/css/messagePage.css">
</head>
<body>
    <div class="directory">
        <div class="logo-directory">
            <a href=""><img class="logo-top" src="./assets/logo.svg"></a>
            <p>Home/Messages</p>
        </div>
        <a href="#" class="settings"><span class="material-symbols-outlined">power_settings_new</span></a>
    </div>
    <div class="sidebar">
        <div class="sidebar-no-settings">
            <a href="/studentHomePage" class="icon-link"><img class="home icon" src="/assets/home.png"></a>
            <a href="/searchpage" class="icon-link"><img class="search-icon icon"  src="/assets/search.png"></a>
            <a href="/hirePage" class="icon-link"><img class="search-icon icon" src="/assets/job-icon.png"></a>
            <a href="/notificationPage" class="icon-link"><img class="notifications icon"  src="/assets/bell.png"></a>
            <a href="/collabPage" class="icon-link"><img class="users icon"  src="/assets/users.png"></a>
            <a href="/messagePage" class="icon-link  open"><img class="messages icon"  src="/assets/send.png"></a>
            <a href="/profilePage" class="icon-link "><img class="profile icon"  src="/assets/profile.png"></a> 
        </div>        
    </div>
    <div class="dropdown">
        <div class="list">
          <div class="item"><button class="deleteacc">Delete Account</button></div>
          <div class="item"><button class="logoutbutton">Log Out</button></div>
        </div>
      </div>
    <div class="popup-container" id="popup-container">
        <div class="popup" id="popup">
            <h2>LogOut</h2>
            <p>Are you sure you want to log out?</p>
            <div class="logout-options">
                <form action="/logout" method="post"> <button id="logout">Yes</button> </form>
                <button id="close-popup">No</button>
            </div>
        </div>
    </div>
    <div class="delete-popup-container" id="delete-popup-container">
        <div class="delete-popup" id="delete-popup">
            <h2>Delete</h2>
            <p>Are you sure you want to Delete your account?</p>
            <div class="delete-options">
                <form action="/deletetheuser" method="post"> <button id="delete">Yes</button> </form>
                <button id="close-delete-popup">No</button>
            </div>
        </div>
    </div>
    <div class="main-cont">
        <div class="msg-box">
            <div class="contacts">
                    <div class="contact-chats">
                        <div class="contacts-head">
                            <div class="message-icon">
                                <i class="fa-regular fa-message"></i>
                            </div>
                            <div class="message-requests">
                                <button class="msg-requests btn btn-primary">Requests <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>
                        <div class="contacts-list">
                            <%if(users.length>0){%>
                                <%for(let i=0;i<users.length;i++){%>
                                    <button class="contact-chat"  id="contact-<%=users[i]['id']%>" data-id="<%=users[i]['id']%>">
                                        <div class="contact">
                                            <div class="contact-profile">
                                                <img src="<%=users[i]['profileImg']%>" alt="profile">
                                            </div>
                                            <div class="contact-details">
                                                <h5><%=users[i]['fullname']%></h5>
                                            </div>
                                        </div>  
                                    </button>
                                <%}%>
                            <%}%>
                        </div>
                    </div>
                    <div class="msg-requests-div">
                        <div class="req-head">
                            <button class="close-req"><i class="fa-solid fa-arrow-left"></i></button>
                            <span class="declined-msg"><i class="fa-solid fa-circle-info" style="color: #6f747b;"></i>The request has been declined</span>
                        </div>
                        <div class="req-list">
                            <div class="reqsts " id="req1">
                                <div class="req-profile">
                                    <img src="./assets/profile-pic2.png" alt="profile">
                                </div>
                                <div class="req-details">
                                    <div class="req-contact-name">
                                        <h5>Sid</h5>
                                    </div>
                                    
                                    <div class="req-btns">
                                        <button class="accept-req">Accept</button>
                                        <button class="decline-req">Decline</button>
                                    </div>
                                </div>
                            </div>
                            <div class="reqsts" id="req2">
                                <div class="req-profile">
                                    <img src="./assets/profile-pic3.png" alt="profile">
                                </div>
                                <div class="req-details">
                                    <div class="req-contact-name">
                                        <h5>Arpita</h5>
                                    </div>
                                    
                                    <div class="req-btns">
                                        <button class="accept-req">Accept</button>
                                        <button class="decline-req">Decline</button>
                                    </div>
                                </div>
                            </div>
                            <div class="reqsts" id="req3">
                                <div class="req-profile">
                                    <img src="./assets/profile-pic2.png" alt="profile">
                                </div>
                                <div class="req-details">
                                    <div class="req-contact-name">
                                        <h5>Kapil</h5>
                                    </div>
                                    
                                    <div class="req-btns">
                                        <button class="accept-req">Accept</button>
                                        <button class="decline-req">Decline</button>
                                    </div>
                                </div>
                            </div>
                            <div class="reqsts" id="req4">
                                <div class="req-profile">
                                    <img src="./assets/profile-pic5.png" alt="profile">
                                </div>
                                <div class="req-details">
                                    <div class="req-contact-name">
                                        <h5>Neha</h5>
                                    </div>
                                    
                                    <div class="req-btns">
                                        <button class="accept-req">Accept</button>
                                        <button class="decline-req">Decline</button>
                                    </div>
                                </div>
                            </div>
                            <div class="reqsts" id="req5">
                                <div class="req-profile">
                                    <img src="./assets/harry_styles.jpg" alt="profile">
                                </div>
                                <div class="req-details">
                                    <div class="req-contact-name">
                                        <h5>Kalyan</h5>
                                    </div>
                                    
                                    <div class="req-btns">
                                        <button class="accept-req">Accept</button>
                                        <button class="decline-req">Decline</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="starting-chat">
                <p>start-a-conversation</p>
            </div>
            <div class="hide" id="contact-empty-texts">
                <div class="chat">
                    <div class="chat-bar">
                        <div class="chat-info">
                            <div class="chat-profile">
                            </div>
                            <div class="chat-details">
                                <div class="name">
                                </div>
                            </div>
                        </div>
                        <button class="block-user">
                            <i class="fa-solid fa-ban"></i>
                        </button>
                    </div>
                    <div class="messages" id="chat">
                    </div>
                    <div id="user-blocked">
                        <div class="user-blocked-msg">User Blocked</div>
                    </div>
                    <div class="input">
                        <input id="msg-input" placeholder="Type your message here!" type="text" />
                        <button class="send-msg"><i class="fa-regular fa-paper-plane"></i></button>
                    </div>
                </div>
                <div class="block-popup" id="block-popup">
                    <div class="block-msg-popup" id="block-msg-popup">
                        <h5>Are you sure ? you want to block the contact</h5>
                        <button id="yes-close-popup">Yes</button>
                        <button id="no-close-popup">No</button>
                    </div>
                </div>
            </div>
            <%if(users.length>0){%>
                <%for(let i=0;i<users.length;i++){%>
                    <div class="texts hide" id="contact-<%=users[i]['id']%>-texts">
                        <div class="chat">
                            <div class="chat-bar">
                                <div class="chat-info">
                                    <div class="chat-profile">
                                        <img src="<%= users[i]['profileImg']%>" alt="profile">
                                    </div>
                                    <div class="chat-details">
                                        <div class="name">
                                            <%=users[i]['fullname']%>
                                        </div>
                                    </div>
                                </div>
                                <button class="block-user">
                                    <i class="fa-solid fa-ban"></i>
                                </button>
                            </div>
                            <div class="messages" id="chat">
                              
                            </div>
                            <div id="user-blocked">
                                <div class="user-blocked-msg">User Blocked</div>
                            </div>
                            <div class="input">
                                <input id="msg-input" placeholder="Type your message here!" type="text" />
                                <button class="send-msg"><i class="fa-regular fa-paper-plane"></i></button>
                            </div>
                        </div>
                        <div class="block-popup" id="block-popup">
                            <div class="block-msg-popup" id="block-msg-popup">
                                <h5>Are you sure ? you want to block the contact</h5>
                                <button id="yes-close-popup">Yes</button>
                                <button id="no-close-popup">No</button>
                            </div>
                        </div>
                    </div>
                <%}%>
            <%}%>
        </div>
    </div>
</div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var sender_id = '<%=currUserId%>';
        var socket = io('/user-namespace',{
            auth:{
                token:'<%=currUserId%>',
            }
        });
        var receiver_id,j ;
        const contacts = document.querySelectorAll(".contact-chat");
        const contactTexts = document.querySelectorAll(".texts");
        const startingChat = document.querySelector(".starting-chat");
        contacts.forEach(c => {
            c.addEventListener('click',()=>{
                var userId = c.dataset.id;
                receiver_id = userId;
                console.log(userId);
                startingChat.style.display = "none";
                for(let i = 0;i<contacts.length;i++){
                    if(contacts[i] == c)
                        j=i;
                }
                displayCont(j);
            });
        });
        function blockContact(user){
            const blockUser = user.querySelector('.block-user');
            const blockContainer = user.querySelector('#block-popup');
            const blockPopup = user.querySelector('#block-msg-popup');
            const confirmYes = user.querySelector('#yes-close-popup');
            const confirmNo = user.querySelector('#no-close-popup');
            const userBlocked = user.querySelector('#user-blocked');
            const msgInput = user.querySelector('#msg-input');

            blockUser.addEventListener('click', function() {
                blockContainer.style.display = 'flex';
                setTimeout(function() {
                    blockPopup.style.transform = 'scale(1)';
                    blockPopup.style.opacity = '1';
                }, 100);
            });

            confirmNo.addEventListener('click', function() {
                blockPopup.style.transform = 'scale(0.5)';
                blockPopup.style.opacity = '0';
                setTimeout(function() {
                    blockContainer.style.display = 'none';
                }, 300);
            });
            confirmYes.addEventListener('click', function() {
                blockPopup.style.transform = 'scale(0.5)';
                blockPopup.style.opacity = '0';
                blockContainer.style.display = 'none';
                userBlocked.style.display = "flex";
                msgInput.disabled = "true";
            });
        }
        // var messages;
        function displayCont(j){
            contactTexts[j].classList.remove('hide');
            socket.emit('loadOldChats',{sender_id:sender_id,receiver_id:receiver_id});
            blockContact(contactTexts[j]);
            for(let i=0;i<contactTexts.length;i++){
                if(i!==j){
                    console.log(i);
                    contactTexts[i].classList.add('hide');
                }else{
                    let send = contactTexts[j].querySelector('.send-msg');
                    let msgEnter = contactTexts[j].querySelector('#msg-input');
                    msgEnter.addEventListener('keypress',(event)=>{
                        if (event.key === "Enter"){
                            if(msgEnter.value !== ""){
                                let msg = contactTexts[j].querySelector('#msg-input');
                                messages = contactTexts[j].querySelector('.messages');
                                console.log(msg.value);
                                let message = msg.value;
                                const data = {
                                    sender_id:sender_id,
                                    receiver_id:receiver_id,
                                    message:message
                                };
                                console.log(data);
                                sendMsg(data);
                                msg.value = "";
                            }
                        }
                    });
                    send.addEventListener('click',()=>{
                        let msg = contactTexts[j].querySelector('#msg-input');
                        let messages = contactTexts[j].querySelector('.messages');
                        if(msg.value !== ""){
                            console.log(msg.value);
                            let message = msg.value;
                            const data = {
                                sender_id:sender_id,
                                receiver_id:receiver_id,
                                message:message
                            };
                            console.log(data);
                            sendMsg(data);
                            msg.value = "";
                        }
                    })
                }
            }
        }
        async function sendMsg(data) {
            fetch("http://localhost:5000/save-chat", {
                method: "POST",
                headers: {
                "Content-Type": "application/json"
                },
                body: JSON.stringify(data),
            })
            .then((response) => response.json())
            .then((data) => {
                console.log("Success:", data)
                // messages = contactTexts[j].querySelector('.messages');
                console.log(receiver_id);
                let openedchat = document.getElementById(`contact-${receiver_id}-texts`);
                let messages = openedchat.querySelector('.messages');
                let newElement = document.createElement('div');
                newElement.className = 'user1';
                newElement.classList.add('message');
                newElement.innerHTML = data.msg;
                messages.appendChild(newElement);
                newElement.scrollIntoView();
                newElement.scrollIntoView({behavior: "smooth"});
                let messageDetails = {
                    sender_id:sender_id,
                    receiver_id:receiver_id,
                    message:data.msg
                }
                socket.emit('newChat',messageDetails);
            })
            .catch((error) => console.error("Error:", error));
        }
        socket.on('loadNewChat',(messageDetails)=>{
            if(sender_id===messageDetails.receiver_id && receiver_id===messageDetails.sender_id){
                console.log(messageDetails);
                let openedchat = document.getElementById(`contact-${messageDetails.sender_id}-texts`);
                let messages = openedchat.querySelector('.messages');
                let newElement = document.createElement('div');
                newElement.className = 'user2';
                newElement.classList.add('message');
                newElement.innerHTML = messageDetails.message;
                messages.appendChild(newElement);
                newElement.scrollIntoView();
                newElement.scrollIntoView({behavior: "smooth"});
            }
        });

        socket.on('loadChatshelper',(data)=>{
            let openChatBox = document.getElementById(`contact-${data.receiver_id}-texts`);
            let messages = openChatBox.querySelector('.messages');
            var chats = data.chats;
            for(let i=0;i<chats.length;i++){
                let newElement = document.createElement('div');
                if(chats[i].sender_id===sender_id&&chats[i].receiver_id===receiver_id){
                    newElement.className = 'user1';
                }else{
                    newElement.className = 'user2';
                }
                newElement.classList.add('message');
                newElement.innerHTML = chats[i].message;
                messages.appendChild(newElement);
                newElement.scrollIntoView();
                newElement.scrollIntoView({behavior: "smooth"});
            }
        })
    </script>
    <script src="./js/messagePage.js"></script>
    <script src="https://kit.fontawesome.com/6953004357.js" crossorigin="anonymous"></script>
</body>
</html>